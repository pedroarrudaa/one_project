<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LinkedIn-based O-1 Visa Assessment Dashboard</title>
  <style>
    :root {
      --bg: #0b0f19;
      --card: #121829;
      --muted: #8a94a7;
      --text: #e6e9f0;
      --primary: #6c8cff;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b0f19, #0a0d16 50%, #090c14);
      color: var(--text);
    }
    header {
      padding: 24px 24px 8px 24px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subtitle {
      color: var(--muted);
      margin-top: 6px;
      font-size: 14px;
    }
    .container { padding: 0 24px 24px 24px; }
    .grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
    }
    .card {
      background: radial-gradient(1200px 400px at -100% -50%, rgba(108,140,255,0.08), transparent), var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 32px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(108,140,255,0.05);
    }
    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(108,140,255,0.1);
    }
    .upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover {
      background: #5a7cff;
      transform: translateY(-1px);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover {
      background: #1a2035;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .contact-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .contact-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .contact-btn:active {
      transform: translateY(0);
    }
    .rankings-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .rankings-table th,
    .rankings-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .rankings-table th {
      font-weight: 600;
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-weight: 600;
      font-size: 12px;
    }
    .rank-1 { background: #ffd700; color: #000; }
    .rank-2 { background: #c0c0c0; color: #000; }
    .rank-3 { background: #cd7f32; color: #fff; }
    .rank-other { background: var(--border); color: var(--text); }
    .score-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .score-high { background: rgba(34,197,94,0.2); color: var(--accent); }
    .score-medium { background: rgba(245,158,11,0.2); color: var(--warning); }
    .score-low { background: rgba(239,68,68,0.2); color: var(--danger); }
    .social-links {
      display: flex;
      gap: 8px;
    }
    .social-link {
      padding: 4px 8px;
      background: rgba(108,140,255,0.1);
      border: 1px solid rgba(108,140,255,0.3);
      border-radius: 4px;
      color: var(--primary);
      text-decoration: none;
      font-size: 12px;
    }
    .social-link:hover {
      background: rgba(108,140,255,0.2);
    }
    .evidence-list {
      font-size: 12px;
      color: var(--muted);
      max-width: 300px;
    }
    .evidence-item {
      margin-bottom: 2px;
    }
    .social-summary {
      background: rgba(108,140,255,0.1);
      border: 1px solid rgba(108,140,255,0.2);
      border-radius: 4px;
      padding: 4px 6px;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--primary);
      font-weight: 500;
    }
    .status-badge {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-completed { background: rgba(34,197,94,0.2); color: var(--accent); }
    .status-processing { background: rgba(245,158,11,0.2); color: var(--warning); }
    .status-pending { background: rgba(156,163,175,0.2); color: var(--muted); }
    .status-failed { background: rgba(239,68,68,0.2); color: var(--danger); }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden { display: none; }
    .message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .message.success {
      background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3);
      color: var(--accent);
    }
    .message.error {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      color: var(--danger);
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      üéØ LinkedIn-based O-1 Visa Assessment
    </div>
    <div class="subtitle">
      AI-powered LinkedIn profile analysis for O-1 visa compatibility using GPT-4o-mini
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left Panel: Upload & Controls -->
      <div>
        <div class="card">
          <div class="card-title">üìÅ Upload Profiles</div>
          
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <div>Drop CSV file here or click to browse</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
              Supports CSV with profile data
            </div>
          </div>
          
          <input type="file" id="fileInput" accept=".csv" style="display: none;" />
          
          <div id="uploadMessage" class="hidden"></div>
          
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button class="btn" id="processBtn" disabled>
              <span class="loading hidden" id="processLoading"></span>
              üöÄ Process All Profiles
            </button>
            <button class="btn btn-secondary" id="refreshBtn">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <!-- System Stats -->
        <div class="card" style="margin-top: 16px;">
          <div class="card-title">üìä System Stats</div>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-value" id="totalProfiles">-</div>
              <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="completedProfiles">-</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="processingProfiles">-</div>
              <div class="stat-label">Processing</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="pendingProfiles">-</div>
              <div class="stat-label">Pending</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Rankings Table -->
      <div class="card">
        <div class="card-title">üèÜ O-1 Visa Compatibility Rankings</div>
        
        <div id="rankingsContainer">
          <table class="rankings-table" id="rankingsTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Full Name</th>
                <th>Social Links</th>
                <th>Email</th>
                <th>Score</th>
                <th>Evidence Summary</th>
                <th>Contact Profile</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="rankingsBody">
              <tr>
                <td colspan="8" style="text-align: center; color: var(--muted); padding: 40px;">
                  No rankings available. Upload and process profiles to see results.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadMessage = document.getElementById('uploadMessage');
    const processBtn = document.getElementById('processBtn');
    const processLoading = document.getElementById('processLoading');
    const refreshBtn = document.getElementById('refreshBtn');
    const rankingsBody = document.getElementById('rankingsBody');
    
    // Stats elements
    const totalProfiles = document.getElementById('totalProfiles');
    const completedProfiles = document.getElementById('completedProfiles');
    const processingProfiles = document.getElementById('processingProfiles');
    const pendingProfiles = document.getElementById('pendingProfiles');

    // File upload handling
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    // Process profiles
    processBtn.addEventListener('click', processAllProfiles);
    refreshBtn.addEventListener('click', loadData);

    // File upload function
    async function handleFileUpload(file) {
      if (!file.name.endsWith('.csv')) {
        showMessage('Please select a CSV file.', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      try {
        showMessage('Uploading CSV file...', 'success');
        
        const response = await fetch('/profiles/upload-csv', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          showMessage(`Successfully uploaded ${result.length} profiles!`, 'success');
          processBtn.disabled = false;
          loadData();
        } else {
          const error = await response.json();
          showMessage(`Upload failed: ${error.detail}`, 'error');
        }
      } catch (error) {
        showMessage(`Upload error: ${error.message}`, 'error');
      }
    }

    // Process all profiles
    async function processAllProfiles() {
      processBtn.disabled = true;
      processLoading.classList.remove('hidden');
      
      try {
        showMessage('Processing profiles through LinkedIn pipeline...', 'success');
        
        const response = await fetch('/profiles/process-batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ max_concurrent: 3 })
        });

        if (response.ok) {
          const result = await response.json();
          showMessage(`Processing completed! ${result.successful} successful, ${result.failed} failed.`, 'success');
          loadData();
        } else {
          const error = await response.json();
          showMessage(`Processing failed: ${error.detail}`, 'error');
        }
      } catch (error) {
        showMessage(`Processing error: ${error.message}`, 'error');
      } finally {
        processBtn.disabled = false;
        processLoading.classList.add('hidden');
      }
    }

    // Load data
    async function loadData() {
      await Promise.all([loadStats(), loadRankings()]);
    }

    // Load system stats
    async function loadStats() {
      try {
        const response = await fetch('/stats');
        if (response.ok) {
          const stats = await response.json();
          totalProfiles.textContent = stats.total_profiles;
          completedProfiles.textContent = stats.completed;
          processingProfiles.textContent = stats.processing;
          pendingProfiles.textContent = stats.pending;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Load rankings
    async function loadRankings() {
      try {
        console.log('Loading rankings...');
        const response = await fetch('/rankings?limit=500');
        console.log('Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Rankings data received:', data.rankings?.length || 0, 'profiles');
          displayRankings(data.rankings);
        } else {
          console.error('Rankings response not ok:', response.status);
        }
      } catch (error) {
        console.error('Failed to load rankings:', error);
      }
    }

    // Generate personalized email for outreach
    function generatePersonalizedEmail(profile) {
      const firstName = profile.full_name.split(' ')[0];
      const topSignals = generateTopSignals(profile);
      
      const subject = `O-1 Visa Opportunity for ${firstName}`;
      
      const emailBody = `Hi ${firstName},

TLDR: Many professionals aren‚Äôt aware of the O-1/EB-1 visas, which provide a path to live and work in the U.S. without quota restrictions. From your achievements, you may already qualify, and I‚Äôd be glad to share more details if you‚Äôre interested.

I‚Äôm Sahar, an AI founder who came to the U.S. on an O-1 visa and later obtained an EB-1 Green Card. Both are non-quota visas designed for experts with extraordinary ability.

Your profile: ${topSignals}, suggests you could be eligible for an O-1/EB-1 visa. Many talents AI operators aren‚Äôt aware of these option, which is increasingly lucrative given today‚Äôs immigration uncertainties. Importantly, spouses are also allowed to work on these visas.

I‚Äôve been through this process myself and now try to make it easier for others, including connecting them with legal firms that are credible and specialize in working with AI talent. My goal is to help more talented AI folks pursue their professional goals without the immigration burden. 

To assess fit, please complete his short form (take <5 minutes).

Looking forward,
Sahar
linkedin.com/in/sahar-mor

P.S. I run a community for O-1/EB-1 applicants, publish a blog for AI developers and researchers, and organize events to connect and grow the AI community.`;

      // Create mailto link with hidden links in HTML version
      const htmlBody = emailBody
        .replace('community for O-1/EB-1 applicants', '<a href="https://discord.com/invite/9jk6fhME4V" style="color: #667eea; text-decoration: none;">community for O-1/EB-1 applicants</a>')
        .replace('blog for AI developers and researchers', '<a href="https://www.aitidbits.ai/" style="color: #667eea; text-decoration: none;">blog for AI developers and researchers</a>')
        .replace('organize events', 'organize <a href="https://lu.ma/genai-sf" style="color: #667eea; text-decoration: none;">events</a>')
        .replace('short form (take <5 minutes)', '<a href="https://forms.gle/n4Gyr7L1SoBY97yGA" style="color: #667eea; text-decoration: none;">short form</a> (take &lt;5 minutes)');
      
      return {
        subject: subject,
        body: emailBody,
        htmlBody: htmlBody,
        mailto: `mailto:${profile.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`
      };
    }
    
    // Generate top signals for each profile
    function generateTopSignals(profile) {
      const signals = [];
      
      // Add company prestige
      if (profile.evidence && profile.evidence.company_prestige) {
        const company = profile.evidence.company_prestige[0];
        if (company && (company.includes('Google') || company.includes('Meta') || company.includes('Apple') || 
                       company.includes('Microsoft') || company.includes('Amazon') || company.includes('NVIDIA'))) {
          signals.push('top-tier tech company experience');
        }
      }
      
      // Add education prestige
      if (profile.evidence && profile.evidence.professional_seniority) {
        const education = profile.evidence.professional_seniority.find(item => 
          item.includes('Stanford') || item.includes('MIT') || item.includes('Harvard') || 
          item.includes('Carnegie Mellon') || item.includes('Berkeley'));
        if (education) {
          signals.push('prestigious university background');
        }
      }
      
      // Add high score indicator
      if (profile.score >= 7.0) {
        signals.push('exceptional professional achievements');
      } else if (profile.score >= 6.0) {
        signals.push('strong professional background');
      } else if (profile.score >= 5.0) {
        signals.push('solid professional experience');
      }
      
      // Add LinkedIn network strength
      if (profile.follower_counts) {
        const totalReach = (profile.follower_counts.linkedin_connections || 0) + 
                          (profile.follower_counts.linkedin_followers || 0);
        if (totalReach >= 5000) {
          signals.push('strong professional network');
        } else if (totalReach >= 1000) {
          signals.push('growing professional network');
        }
      }
      
      // Add bonus achievements
      if (profile.evidence && profile.evidence.bonus_achievements && profile.evidence.bonus_achievements.length > 0) {
        signals.push('notable achievements and recognition');
      }
      
      // Default if no specific signals
      if (signals.length === 0) {
        signals.push('technical background and professional experience');
      }
      
      return signals.join(', ');
    }
    
    // Simplified email function using data attributes
    function openPersonalizedEmailSimple(button) {
      try {
        const email = button.dataset.email;
        const fullName = button.dataset.name;
        const score = parseFloat(button.dataset.score);
        const company = button.dataset.company;
        
        const firstName = fullName.split(' ')[0];
        
        // Generate simple top signals
        const signals = [];
        if (score >= 7.0) signals.push('exceptional professional achievements');
        else if (score >= 6.0) signals.push('strong professional background');
        else if (score >= 5.0) signals.push('solid professional experience');
        
        if (company && (company.includes('Google') || company.includes('Meta') || company.includes('Apple') || 
                       company.includes('Microsoft') || company.includes('Amazon') || company.includes('NVIDIA'))) {
          signals.push('top-tier tech company experience');
        }
        
        signals.push('strong LinkedIn professional network');
        
        const topSignals = signals.join(', ');
        
        const subject = `O-1 Visa Opportunity for ${firstName}`;
        
        const emailBody = `Hi ${firstName},

TLDR: Many professionals aren‚Äôt aware of the O-1/EB-1 visas, which provide a path to live and work in the U.S. without quota restrictions. From your achievements, you may already qualify, and I‚Äôd be glad to share more details if you‚Äôre interested.

I‚Äôm Sahar, an AI founder who came to the U.S. on an O-1 visa and later obtained an EB-1 Green Card. Both are non-quota visas designed for experts with extraordinary ability.

Your profile: ${topSignals}, suggests you could be eligible for an O-1/EB-1 visa. Many talents AI operators aren‚Äôt aware of these option, which is increasingly lucrative given today‚Äôs immigration uncertainties. Importantly, spouses are also allowed to work on these visas.

I‚Äôve been through this process myself and now try to make it easier for others, including connecting them with legal firms that are credible and specialize in working with AI talent. My goal is to help more talented AI folks pursue their professional goals without the immigration burden. 

To assess fit, please complete his short form (take <5 minutes).

Looking forward,
Sahar
linkedin.com/in/sahar-mor

P.S. I run a community for O-1/EB-1 applicants, publish a blog for AI developers and researchers, and organize events to connect and grow the AI community.`;

        // Create two versions: clean text for email client, HTML for preview
        const cleanEmailBody = emailBody
          .replace('community for O-1/EB-1 applicants', 'community for O-1/EB-1 applicants (https://discord.com/invite/9jk6fhME4V)')
          .replace('blog for AI developers and researchers', 'blog for AI developers and researchers (https://www.aitidbits.ai/)')
          .replace('organize events', 'organize events (https://lu.ma/genai-sf)')
          .replace('short form (take <5 minutes)', 'short form (https://forms.gle/n4Gyr7L1SoBY97yGA) (take <5 minutes)');
        
        const htmlPreviewBody = emailBody
          .replace('community for O-1/EB-1 applicants', '<a href="https://discord.com/invite/9jk6fhME4V" style="color: #667eea; text-decoration: none;">community for O-1/EB-1 applicants</a>')
          .replace('blog for AI developers and researchers', '<a href="https://www.aitidbits.ai/" style="color: #667eea; text-decoration: none;">blog for AI developers and researchers</a>')
          .replace('organize events', 'organize <a href="https://lu.ma/genai-sf" style="color: #667eea; text-decoration: none;">events</a>')
          .replace('short form (take <5 minutes)', '<a href="https://forms.gle/n4Gyr7L1SoBY97yGA" style="color: #667eea; text-decoration: none;">short form</a> (take &lt;5 minutes)');
        
        // Open modal only; do not open the email client automatically
        showEmailPreviewWithClickableLinks(subject, cleanEmailBody, htmlPreviewBody, email);
        
      } catch (error) {
        console.error('Error generating email:', error);
        alert('Error generating email. Please try again.');
      }
    }
    
    // Show email preview modal
    function showEmailPreview(emailData) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--card); border-radius: 12px; padding: 24px; 
          max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
          border: 1px solid var(--border);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--text);">üìß Personalized Email Preview</h3>
            <button onclick="this.closest('div').parentElement.remove()" style="
              background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);
            ">√ó</button>
          </div>
          
          <div style="margin-bottom: 12px;">
            <strong>Subject:</strong> <span style="color: var(--primary);">${subject}</span>
          </div>
          
          <div style="margin-bottom: 16px;">
            <strong>Email Body:</strong>
            <textarea readonly style="width: 100%; height: 300px; margin-top: 8px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 13px; line-height: 1.4; resize: vertical;">${body}</textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="copyEmailToClipboard(this)" data-email-body="${body.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
              class="contact-btn" style="background: #28a745;">
              üìã Copy Email
            </button>
            <button onclick="this.closest('div').parentElement.remove()" 
              class="contact-btn" style="background: #6c757d;">
              Close
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
    
    // Simplified email preview
    function showEmailPreviewSimple(subject, body, email) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--card); border-radius: 12px; padding: 24px; 
          max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
          border: 1px solid var(--border);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--text);">üìß Email Preview</h3>
            <button onclick="this.closest('div').parentElement.remove()" style="
              background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);
            ">√ó</button>
          </div>
          
          <div style="margin-bottom: 12px;">
            <strong>To:</strong> <span style="color: var(--primary);">${email}</span>
          </div>
          
          <div style="margin-bottom: 12px;">
            <strong>Subject:</strong> <span style="color: var(--primary);">${subject}</span>
          </div>
          
          <div style="margin-bottom: 16px;">
            <strong>Message:</strong>
            <textarea readonly style="
              width: 100%; height: 300px; margin-top: 8px; padding: 12px;
              background: var(--bg); border: 1px solid var(--border);
              border-radius: 6px; color: var(--text); font-family: monospace;
              font-size: 13px; line-height: 1.4; resize: vertical;
            ">${body}</textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="navigator.clipboard.writeText(\`${body.replace(/`/g, '\\`')}\`); this.textContent='‚úÖ Copied!'" 
              class="contact-btn" style="background: #28a745;">
              üìã Copy Email
            </button>
            <button onclick="this.closest('div').parentElement.remove()" 
              class="contact-btn" style="background: #6c757d;">
              Close
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }
    
    // Show email preview with clickable links
    function showEmailPreviewWithClickableLinks(subject, plainBody, htmlBody, email) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--card); border-radius: 12px; padding: 24px; 
          max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto;
          border: 1px solid var(--border);
        ">
          <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--text);">üìß Personalized Outreach Email</h3>
          </div>
          
          <div style="margin-bottom: 12px;">
            <strong>To:</strong> <span style="color: var(--primary);">${email}</span>
          </div>
          
          <div style="margin-bottom: 16px;">
            <strong>Subject:</strong> <span style="color: var(--primary);">${subject}</span>
          </div>
          
          <div style="margin-bottom: 20px;">
            <strong>üìß Email Preview:</strong>
            <div style="
              background: white; color: #333; padding: 16px; border-radius: 8px; 
              border: 1px solid #ddd; font-family: Arial, sans-serif; line-height: 1.6;
              max-height: 300px; overflow-y: auto;
              margin-bottom: 12px;
            ">${htmlBody.replace(/\n/g, '<br><br>')}</div>
            <div style="color: var(--muted); font-size: 12px; margin-bottom: 6px;">Edit message (plain text used for sending):</div>
            <textarea id="emailEditor" style="width: 100%; height: 180px; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 13px; line-height: 1.5;">${plainBody}</textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="saveEmailDraft(this)" 
              data-email="${email}" 
              data-subject="${subject.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
              class="contact-btn" style="background: var(--primary);">
              Save & Approve
            </button>
            <button onclick="sendEmailFromModal(this)" 
              data-email="${email}" 
              data-subject="${subject.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}"
              class="contact-btn" style="background: var(--primary);">
              Send
            </button>
            <button onclick="this.closest('div').parentElement.remove()" 
              class="contact-btn" style="background: var(--primary);">
              Close
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Save draft to localStorage for later reference
    function saveEmailDraft(button) {
      try {
        const email = button.dataset.email;
        const subject = button.dataset.subject.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        const editor = document.getElementById('emailEditor');
        const body = editor ? editor.value : '';
        const key = `draft:${email}:${subject}`;
        localStorage.setItem(key, body);
        const original = button.textContent;
        button.textContent = 'Saved';
        setTimeout(() => { button.textContent = 'Save & Approve'; }, 1500);
      } catch (err) {
        console.error('Failed to save draft', err);
      }
    }

    // Send using Gmail compose with the edited body
    function sendEmailFromModal(button) {
      try {
        const email = button.dataset.email;
        const subject = button.dataset.subject.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        const editor = document.getElementById('emailEditor');
        const body = editor ? editor.value : '';
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(gmailUrl, '_blank');
        const original = button.textContent;
        button.textContent = 'Sent';
        setTimeout(() => { button.textContent = 'Send'; }, 1500);
      } catch (error) {
        console.error('Error opening Gmail:', error);
        button.textContent = 'Failed';
        setTimeout(() => { button.textContent = 'Send'; }, 1500);
      }
    }
    
    // Copy email text (plain or HTML)
    function copyEmailText(button, type) {
      try {
        const text = button.dataset.text.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        navigator.clipboard.writeText(text);
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      } catch (error) {
        console.error('Copy failed:', error);
        button.textContent = '‚ùå Failed';
      }
    }
    
    // Open Gmail directly with clean text content
    function openGmailDirect(button) {
      try {
        const email = button.dataset.email;
        const subject = button.dataset.subject.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        const plainBody = button.dataset.plainBody.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(plainBody)}`;
        window.open(gmailUrl, '_blank');
        
        button.textContent = '‚úÖ Opened!';
        setTimeout(() => {
          button.textContent = 'üìß Open Gmail';
        }, 2000);
      } catch (error) {
        console.error('Error opening Gmail:', error);
        button.textContent = '‚ùå Failed';
      }
    }

    // Display rankings
    function displayRankings(rankings) {
      console.log('displayRankings called with:', rankings?.length || 0, 'rankings');
      
      if (!rankings || rankings.length === 0) {
        console.log('No rankings to display');
        rankingsBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; color: var(--muted); padding: 40px;">
              No rankings available. Upload and process profiles to see results.
            </td>
          </tr>
        `;
        return;
      }
      
      console.log('Displaying', rankings.length, 'rankings');

      rankingsBody.innerHTML = rankings.map(ranking => `
        <tr>
          <td>
            <span class="rank-badge ${getRankClass(ranking.rank)}">${ranking.rank}</span>
          </td>
          <td><strong>${ranking.full_name}</strong></td>
          <td>
            <div class="social-links">
              ${Object.entries(ranking.social_links || {}).map(([platform, url]) => 
                `<a href="${url}" target="_blank" class="social-link">${platform}</a>`
              ).join('')}
            </div>
          </td>
          <td>
            <a href="mailto:${ranking.email}" style="color: var(--primary);">${ranking.email}</a>
          </td>
          <td>
            <div class="score-badge ${getScoreClass(ranking.score)}">${ranking.score?.toFixed(1) || 'N/A'}</div>
            <div style="font-size: 10px; color: var(--muted); margin-top: 2px;">${ranking.likelihood || 'Unknown'}</div>
          </td>
          <td>
            <div class="evidence-list">
              ${formatEvidence(ranking.evidence, ranking.follower_counts)}
            </div>
          </td>
          <td>
            <button class="contact-btn" 
              data-email="${ranking.email}" 
              data-name="${ranking.full_name}" 
              data-score="${ranking.score}" 
              data-company="${ranking.evidence?.company_prestige?.[0] || 'N/A'}"
              onclick="openPersonalizedEmailSimple(this)">
              üìß Contact
            </button>
          </td>
          <td>
            <span class="status-badge status-${ranking.processing_status}">${ranking.processing_status}</span>
          </td>
        </tr>
      `).join('');
    }

    // Helper functions
    function getRankClass(rank) {
      if (rank === 1) return 'rank-1';
      if (rank === 2) return 'rank-2';
      if (rank === 3) return 'rank-3';
      return 'rank-other';
    }

    function getScoreClass(score) {
      if (score >= 7) return 'score-high';
      if (score >= 5) return 'score-medium';
      return 'score-low';
    }

    function formatEvidence(evidence, followerCounts) {
      try {
        if (!evidence || Object.keys(evidence).length === 0) {
          return '<div style="color: var(--muted);">No evidence available</div>';
        }
        
        const items = [];
        
        // Add LinkedIn followers summary at the top (GitHub removed)
        try {
          const socialSummary = formatLinkedInSummary(followerCounts);
          if (socialSummary) {
            items.push(`<div class="social-summary">${socialSummary}</div>`);
          }
        } catch (e) {
          console.warn('Error formatting LinkedIn summary:', e);
        }
        
        // Add evidence items safely
        try {
          Object.entries(evidence).forEach(([category, evidenceList]) => {
            if (evidenceList && Array.isArray(evidenceList) && evidenceList.length > 0) {
              const safeList = evidenceList.slice(0, 2).map(item => String(item)).join(', ');
              items.push(`<strong>${category}:</strong> ${safeList}`);
            }
          });
        } catch (e) {
          console.warn('Error formatting evidence:', e);
          items.push('<div style="color: var(--muted);">Evidence format error</div>');
        }
        
        return items.slice(0, 4).map(item => `<div class="evidence-item">${item}</div>`).join('');
        
      } catch (error) {
        console.error('formatEvidence error:', error);
        return '<div style="color: var(--muted);">Evidence unavailable</div>';
      }
    }
    
    function formatLinkedInSummary(followerCounts) {
      if (!followerCounts) return '';
      
      const connections = followerCounts.linkedin_connections || 0;
      const followers = followerCounts.linkedin_followers || 0;
      const total = connections + followers;
      
      if (total === 0) return '';
      
      return `LinkedIn Network: ${connections.toLocaleString()} connections + ${followers.toLocaleString()} followers = ${total.toLocaleString()} total reach`;
    }

    // formatSocialMediaSummary function completely removed

    function showMessage(text, type) {
      uploadMessage.className = `message ${type}`;
      uploadMessage.textContent = text;
      uploadMessage.classList.remove('hidden');
      
      setTimeout(() => {
        uploadMessage.classList.add('hidden');
      }, 5000);
    }

    // Initial load
    loadData();
    
    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
  </script>
</body>
</html>